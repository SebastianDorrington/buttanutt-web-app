<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Production manager</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; min-height: 100vh; padding: 1rem; background: #fff; color: #000; }
    header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    header a { color: #000; text-decoration: none; }
    header a:hover { text-decoration: underline; }
    .logo { height: 36px; width: auto; display: block; }
    .card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .card h2 { margin: 0 0 1rem; font-size: 1rem; color: #333; }
    label { display: block; margin-bottom: 0.35rem; font-size: 0.875rem; color: #333; }
    input, select, textarea {
      width: 100%;
      max-width: 20rem;
      padding: 0.6rem 0.75rem;
      margin-bottom: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f0f0f0;
      color: #222;
      font-size: 1rem;
    }
    input::placeholder, textarea::placeholder { color: #666; }
    select option { background: #fff; color: #222; }
    textarea { min-height: 3rem; resize: vertical; max-length: 250; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #666; }
    button {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 6px;
      background: #fff;
      color: #000;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-top: 0.25rem;
    }
    button:hover { background: #e0e0e0; }
    button.danger { background: #333; color: #fff; }
    button.danger:hover { background: #444; }
    .msg { margin-top: 0.5rem; font-size: 0.875rem; }
    .msg.success { color: #333; }
    .msg.error { color: #c00; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { text-align: left; padding: 0.5rem 0.4rem; border-bottom: 1px solid #ddd; }
    th { color: #333; font-weight: 500; }
    .section-actions { margin-top: 0.75rem; }
    .note-hint { font-size: 0.8rem; color: #666; }
  </style>
</head>
<body>
  <header>
    <a href="/manager.html"><img src="/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'"></a>
    <h1 style="margin:0; font-size:1.25rem;">Production manager</h1>
    <a href="/logout" style="margin-left:auto;">Sign out</a>
  </header>

  <div class="card">
    <h2>1. Log weekly targets</h2>
    <form id="weeklyForm">
      <label for="week_date">Week starting (date)</label>
      <select id="week_date" name="week_start_date">
        <option value="">Select week…</option>
      </select>
      <label for="w_variant">Variant</label>
      <select id="w_variant" name="variant_id">
        <option value="">Select variant…</option>
      </select>
      <label for="w_units">Units</label>
      <input type="number" id="w_units" name="target_units" min="0" step="1" placeholder="e.g. 100">
      <button type="submit">Save weekly target</button>
    </form>
    <p id="weeklyMsg" class="msg"></p>
    <div class="section-actions">
      <button type="button" class="danger" id="deleteWeeklyBtn">Delete my most recent weekly target</button>
    </div>
  </div>

  <div class="card">
    <h2>2. Log daily actual production</h2>
    <form id="dailyForm">
      <label for="prod_date">Production date</label>
      <input type="date" id="prod_date" name="production_date">
      <label for="d_variant">Variant</label>
      <select id="d_variant" name="variant_id">
        <option value="">Select variant…</option>
      </select>
      <label for="d_units">Units</label>
      <input type="number" id="d_units" name="units" min="0" step="1" placeholder="e.g. 50">
      <label for="d_hours">Hours spent</label>
      <input type="number" id="d_hours" name="hours" min="0" step="1" placeholder="e.g. 8">
      <label for="d_note">Note (e.g. reason for shortfall, max 250 characters)</label>
      <textarea id="d_note" name="note" maxlength="250" placeholder="e.g. Line downtime for 2 hours"></textarea>
      <span class="note-hint" id="noteCount">0 / 250</span>
      <button type="submit">Save daily production</button>
    </form>
    <p id="dailyMsg" class="msg"></p>
    <div class="section-actions">
      <button type="button" class="danger" id="deleteDailyBtn">Delete my most recent daily actual</button>
    </div>
  </div>

  <div class="card">
    <h2>3. Target vs production (by week)</h2>
    <table>
      <thead>
        <tr><th>Week</th><th>Variant</th><th>Target</th><th>Produced</th><th>% of target</th></tr>
      </thead>
      <tbody id="targetVsBody"></tbody>
    </table>
    <p id="targetVsEmpty" class="msg" style="color:#666;">No weekly targets yet.</p>
  </div>

  <script>
    function toDDMMYYYY(iso) {
      if (!iso || iso.length < 10) return '';
      const [y, m, d] = iso.slice(0, 10).split('-');
      return d + '/' + m + '/' + y;
    }
    function getMondayDate(d) {
      const date = new Date(d);
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      const mon = new Date(date);
      mon.setDate(diff);
      return mon;
    }
    function nextFourMondays() {
      const today = new Date();
      const thisMon = getMondayDate(today);
      const out = [];
      for (let i = 0; i < 4; i++) {
        const m = new Date(thisMon);
        m.setDate(thisMon.getDate() + i * 7);
        out.push({ iso: m.toISOString().slice(0, 10), label: toDDMMYYYY(m.toISOString().slice(0, 10)) });
      }
      return out;
    }
    const mondays = nextFourMondays();
    const weekSelect = document.getElementById('week_date');
    weekSelect.innerHTML = '<option value="">Select week…</option>' + mondays.map(m => `<option value="${m.iso}">${m.label}</option>`).join('');
    weekSelect.value = mondays[0].iso;
    document.getElementById('prod_date').value = new Date().toISOString().slice(0, 10);

    document.getElementById('d_note').addEventListener('input', function() {
      document.getElementById('noteCount').textContent = this.value.length + ' / 250';
    });

    function msg(el, text, type) {
      const p = document.getElementById(el);
      p.textContent = text;
      p.className = 'msg ' + (type || 'success');
      if (type !== 'error') setTimeout(() => { p.textContent = ''; }, 4000);
    }

    async function api(method, url, body) {
      const opt = { method, headers: {} };
      if (body) { opt.headers['Content-Type'] = 'application/json'; opt.body = JSON.stringify(body); }
      const r = await fetch(url, opt);
      const data = r.ok ? await r.json().catch(() => ({})) : await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    let variants = [];
    async function loadVariants() {
      variants = await api('GET', '/api/variants');
      const opts = variants.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      document.getElementById('w_variant').innerHTML = '<option value="">Select variant…</option>' + opts;
      document.getElementById('d_variant').innerHTML = '<option value="">Select variant…</option>' + opts;
    }

    document.getElementById('weeklyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const weekStart = fd.get('week_start_date');
      const variantId = fd.get('variant_id');
      const targetUnits = fd.get('target_units');
      if (!variantId || !targetUnits) {
        msg('weeklyMsg', 'Select variant and enter target units.', 'error');
        return;
      }
      try {
        await api('POST', '/api/weekly-targets', {
          week_start_date: weekStart,
          variant_id: parseInt(variantId, 10),
          target_units: parseInt(targetUnits, 10) || 0
        });
        msg('weeklyMsg', 'Weekly target saved.');
        e.target.querySelector('#w_units').value = '';
        loadTargetVs();
      } catch (err) {
        msg('weeklyMsg', err.message, 'error');
      }
    });

    document.getElementById('dailyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      try {
        await api('POST', '/api/daily-production', {
          production_date: fd.get('production_date'),
          variant_id: parseInt(fd.get('variant_id'), 10),
          units: parseInt(fd.get('units'), 10) || 0,
          hours: fd.get('hours') ? parseInt(fd.get('hours'), 10) : null,
          note: (fd.get('note') || '').trim().slice(0, 250) || null
        });
        msg('dailyMsg', 'Daily production saved.');
        document.getElementById('d_units').value = '';
        document.getElementById('d_hours').value = '';
        document.getElementById('d_note').value = '';
        document.getElementById('noteCount').textContent = '0 / 250';
        loadTargetVs();
      } catch (err) {
        msg('dailyMsg', err.message, 'error');
      }
    });

    document.getElementById('deleteWeeklyBtn').addEventListener('click', async () => {
      if (!confirm('Delete your most recent weekly target?')) return;
      try {
        await api('DELETE', '/api/weekly-targets/most-recent');
        msg('weeklyMsg', 'Most recent weekly target deleted.');
        loadTargetVs();
      } catch (err) {
        msg('weeklyMsg', err.message, 'error');
      }
    });

    document.getElementById('deleteDailyBtn').addEventListener('click', async () => {
      if (!confirm('Delete your most recent daily actual?')) return;
      try {
        await api('DELETE', '/api/daily-production/most-recent');
        msg('dailyMsg', 'Most recent daily actual deleted.');
        loadTargetVs();
      } catch (err) {
        msg('dailyMsg', err.message, 'error');
      }
    });

    async function loadTargetVs() {
      const list = await api('GET', '/api/target-vs-production');
      const tbody = document.getElementById('targetVsBody');
      const empty = document.getElementById('targetVsEmpty');
      if (!list.length) {
        tbody.innerHTML = '';
        empty.hidden = false;
        return;
      }
      empty.hidden = true;
      tbody.innerHTML = list.map(row => `
        <tr>
          <td>${toDDMMYYYY(row.week_start_date)}</td>
          <td>${row.variant_name}</td>
          <td>${row.target}</td>
          <td>${row.produced}</td>
          <td>${row.pct}%</td>
        </tr>
      `).join('');
    }

    loadVariants().then(loadTargetVs);
  </script>
</body>
</html>
